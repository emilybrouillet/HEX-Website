<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Submit New Entry – Embodied Threat Matrix</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
<div id="header"></div>

<main class="container">
  <section class="panel">
    <h1>Submit New Entry</h1>
    <p>Select the tactic (row) and system layer (column) where your new threat or technique belongs. Please include a descriptive justification in the 'Description' section for proper review and to be considered for acceptance.</p>

    <form id="submitForm" style="margin-top:20px;">
      <label for="row">Tactic (Row)</label><br>
      <select id="row" required style="margin-bottom:16px; width:100%; max-width:400px;">
	<option value="" disabled selected>Select a tactic</option>
	<option value="embodiment-preparation">Embodiment Preparation</option>
        <option value="embodied-access">Embodied Access</option>
	<option value="behavior-invocation">Behavior Invocation</option>
	<option value="persistence">Persistence</option>
	<option value="privilege-escalation">Privilege Escalation</option>
	<option value="perception-manipulation">Perception Manipulation</option>
	<option value="embodied-data-harvesting">Embodied Data Harvesting</option>
	<option value="lateral-movement">Lateral Movement</option>
	<option value="behavioral-c2">Behavioral Command & Control</option>
	<option value="physical-exfiltrationt">Embodied Exfiltration</option>
	<option value="embodied-impact">Embodied Impact</option>
      </select><br>

      <label for="column">Domain (Column)</label><br>
      <select id="column" required style="margin-bottom:16px; width:100%; max-width:400px;">
        <option value="" disabled selected>Select a domain</option>
        <option value="social">Social Interface</option>
        <option value="application">Application</option>
        <option value="decision">Decision-making</option>
        <option value="middleware">Middleware</option>
        <option value="data">Data Processing</option>
        <option value="sensing">Sensing & Perception</option>
        <option value="physical">Physical</option>
      </select><br>

      <label for="entry">Title</label><br>
      <textarea id="entry" rows="4" required style="width:100%; max-width:600px; margin-bottom:20px;"
	placeholder="Give the formal tactic name..."
      ></textarea><br>

      <label for="description">Description</label><br>
      <textarea
        id="description"
        rows="5"
        style="width:100%; max-width:600px; margin-bottom:20px;"
        placeholder="Provide context, rationale, or technical detail for this entry..."
      ></textarea><br>

      <button type="submit" class="add-btn">Submit</button>
      <a href="index.html" class="add-btn" style="margin-left:10px;">← Back</a>
    </form>

    <p id="status" style="margin-top:20px; color:var(--purple-accent);"></p>
  </section>
</main>

<script>
  // Load header
  fetch("header.html")
    .then(res => res.text())
    .then(html => document.getElementById("header").innerHTML = html);

  let isSubmitting = false;

  document.getElementById("submitForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    if (isSubmitting) return;

    const statusEl = document.getElementById("status");
    statusEl.textContent = "";

    const tacticId = document.getElementById("row").value;
    const column = document.getElementById("column").value;
    const entry = (document.getElementById("entry").value || "").trim();
    const description = (document.getElementById("description").value || "").trim();

    if (!tacticId || !column || !entry) {
      statusEl.textContent = "Please complete all required fields.";
      return;
    }

    try {
      isSubmitting = true;

      const res = await fetch("/api/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tacticId, column, entry, description })
      });

      const contentType = res.headers.get("content-type") || "";
      const out = contentType.includes("application/json")
        ? await res.json()
        : { error: await res.text() };

      if (!res.ok) {
        statusEl.textContent = out.error || "Submission failed.";
        return;
      }

      statusEl.textContent = out.message || "Submitted.";
      e.target.reset();
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Network or server error.";
    } finally {
      isSubmitting = false;
    }
  });
</script>
</body>
</html>
